# MeowDiff Requirements

## 1.背景与目标
- 捕捉 Git 提交之间及 IDE 撤销栈之外的细粒度改动。
- 支持人类编辑器及 AI/脚本等所有写入来源，生成可追溯的时间线。
- 保障改动历史完全本地化，避免因 IDE 清理或断网造成的数据丢失。

## 2.范围
- 监控单个项目路径的文件写入，记录每次写入的 diff 与元信息。
- 在 `~/.meowdiff/<project-id>/` 中维护历史快照、索引、配置。
- 提供命令行工具用于监听控制、历史查询、diff 展示与回滚。

## 3.非目标
- 首版不提供 GUI、不提供跨路径迁移或历史合并。
- 不实现多用户协作同步、云端存储或自动容量清理策略。

## 4.项目标识与存储
- `project-id` 由项目绝对路径生成哈希（建议 SHA-1，截取前若干字符）。
- 项目搬迁或复制后会得到新的 `project-id`，历史视作独立。
- 所有项目数据放置于 `~/.meowdiff/<project-id>/`，包括：
  - 监听元信息（启动时间、版本、锁文件）。
  - 时间线索引（记录 ID、时间戳、文件列表、摘要）。
  - 每条记录的 diff/快照数据。
  - 日志与调试信息（可选，需分级控制）。

## 5.写入捕捉与记录粒度
- 监听文件系统写入；每一次写入事件生成一条“变更记录”。
- 不合并短时间内的连续写入，即便同一文件短时间、重复保存也独立记录。
- 单条记录可同时包含多个文件或同一文件多个不连续块，仍视作一次变更。
- 记录内容需包含：
  - 触发时间（高精度时间戳）。
  - 涉及文件路径（相对项目根）。
  - 行级 diff 数据；必要时保存原始快照以支持回滚。
  - 可选元信息：触发进程 ID、命令名、用户（后续版本扩展）。

## 6.忽略策略
- 默认忽略列表内置于工具，典型目录/文件：
  - `.git/`, `.svn/`, `.hg/`
  - `.DS_Store`, `.idea/`, `.vscode/`
  - `node_modules/`, `dist/`, `build/`, `coverage/`
  - `__pycache__/`, `venv/`, `.venv/`
- 项目根可提供 `.meowdiffignore`（沿用 `.gitignore` 语法）扩展或覆盖默认规则。
- 支持 `--show` 类命令查看有效忽略规则。
- 工具需确保被忽略路径的变更不会触发记录。

## 7.命令行交互
所有命令默认作用于当前目录，可通过 `--path` 指定其他项目。

### 7.1 监听控制
- `meowdiff watch [path] [--daemon]`：启动监听。输出项目 ID、存储路径、忽略列表摘要；支持前台运行或后台守护。
- `meowdiff stop [path]`：停止监听进程，移除锁。
- `meowdiff status [path] [--json]`：显示监听状态、最后记录时间、存储体积、当前忽略规则摘要。

### 7.2 历史浏览
- `meowdiff timeline [path] [--limit N] [--from ts] [--to ts] [--json]`：列出时间线记录，包含记录 ID、时间、触发来源摘要、改动统计。
- `meowdiff show <record-id> [--json]`：查看指定记录详情与涉及文件列表。
- `meowdiff diff <record-id> [file] [--stat]`：展示记录与前序状态的 diff，可过滤单文件或输出统计。

### 7.3 回滚与导出
- `meowdiff restore <record-id> [--apply] [--print] [--yes]`：恢复记录中的内容。
  - 默认打印提示并要求确认。
  - `--apply` 直接写入工作区。
  - `--print` 输出补丁文本供外部工具使用。
- `meowdiff extract <record-id> --output <dir>`：导出记录快照文件到指定目录。

### 7.4 项目与忽略管理
- `meowdiff projects [--json]`：罗列已知项目（路径、project-id、最后活动时间）。
- `meowdiff inspect <project-id> [--json]`：查看特定项目的统计信息与存储路径。
- `meowdiff ignore list [path] [--json]`：展示有效忽略规则（内置 + 项目自定义）。
- `meowdiff ignore test <path> [--project path]`：检测某文件/目录是否被忽略。

## 8.错误处理与用户反馈
- 监听启动失败时给出错误码与建议（权限、路径不存在、锁冲突）。
- 检测到监听进程意外退出时，`status` 命令应提示并给出重启指令。
- 第一次使用（无历史）时提示 `.meowdiffignore` 的用途及默认忽略列表。
- 操作成功/失败统一使用明确、可脚本化的退出码。

## 9.后续扩展（非首版）
- 路径迁移后的历史导入/绑定工具。
- 更细致的归因信息（进程名、命令行、用户）。
- GUI 或编辑器插件的浏览/恢复界面。
- 历史容量管理（按时间或空间自动清理）。

